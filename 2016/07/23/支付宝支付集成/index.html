<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>支付宝支付集成-2016年7月 | 半墨雨萧年</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="喜仙剑，爱红楼，迷火影，一半电影控，一半古风梦。在iOS开发道路上潜心修行">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="支付宝支付集成-2016年7月 | 半墨雨萧年">
    <meta name="twitter:description" content="喜仙剑，爱红楼，迷火影，一半电影控，一半古风梦。在iOS开发道路上潜心修行">

    <meta property="og:type" content="article">
    <meta property="og:title" content="支付宝支付集成-2016年7月 | 半墨雨萧年">
    <meta property="og:description" content="喜仙剑，爱红楼，迷火影，一半电影控，一半古风梦。在iOS开发道路上潜心修行">

    
    <meta name="author" content="赵新成">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/favicon.png">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="半墨雨萧年" href="/atom.xml">
    

    <link rel="canonical" href="http://xingcheng123.tk/2016/07/23/支付宝支付集成/"/>

    
    <link rel="author" href="https://www.google.com/+LenboMa"/>
    
</head>

<body class="home-template no-js">

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 半墨雨萧年 的主页"><img src="/images/logo2.jpg" width="80" alt="半墨雨萧年 logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for 半墨雨萧年">半墨雨萧年</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">以梦为马，莫负韶华！</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">嗨，我是赵新成，一名来自中国的 iOS 开发者。现居北京。正在修行，探求创意之源。</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">博客</a></li>
            
              <li class="navigation__item"><a href="/projects">项目作品</a></li>
            
              <li class="navigation__item"><a href="/aboutme">关于我</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  
  <li class="navigation__item">
    <a href="http://weibo.com/u/3820143749" title="我的微博" target="_blank">
      <i class='social fa fa-weibo'></i>
      <span class="label">Weibo</span>
    </a>
  </li> 


  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/xincheng123" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  
  <li class="navigation__item">
    <a href="https://www.google.com/+LenboMa" title="Google+" target="_blank">
      <i class='social fa fa-google-plus-square'></i>
      <span class="label">Google+</span>
    </a>
  </li>


<!-- Facebook -->

  
<!-- Twitter -->

  

  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-green"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2016-07-23T09:00:29.000Z" class="post-list__meta--date date">2016-07-23</time> &#8226; <span class="post-meta__tags tags">于&nbsp;</span>
    </div>
    <h1 class="post-title">支付宝支付集成-2016年7月</h1>
  </header>

  <section class="post">
    <blockquote>
<p>iOS的Demo和SDK的下载路径:<a href="https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.HrqInZ&amp;treeId=54&amp;articleId=104509&amp;docType=1" target="_blank" rel="external">这里下载</a></p>
</blockquote>
<h3 id="支付流程理解"><a href="#支付流程理解" class="headerlink" title="支付流程理解"></a>支付流程理解</h3><p>建议先把开发文档仔仔细细看一遍，一定要看，本小白刚开始的时候没有老老实实地看完，结果遇到很多很多的坑，以血和泪劝解大家，浪费的挺多的时间的，所以建议一定要好好看看，特别是交互流程这一部分,支付宝算是支付SDK中比较麻烦的的了</p>
<img src="/2016/07/23/支付宝支付集成/png1.png" alt="官方流程图" title="官方流程图">
<h4 id="流程就是跟咱们平时在手机上买东西是一样的："><a href="#流程就是跟咱们平时在手机上买东西是一样的：" class="headerlink" title="流程就是跟咱们平时在手机上买东西是一样的："></a>流程就是跟咱们平时在手机上买东西是一样的：</h4><ol>
<li>用户选好了商品后，点击提交订单（一般是这样），选择使用支付宝付款。</li>
<li>手机客户端（你做的APP）把用户选择的商品的信息传给你们后台服务器。</li>
<li>后台的服务器将各种数据拼接签名后生成一个签名后的字符串，回传到客户端APP上。</li>
<li>用户点击确认支付按钮，调用手机支付宝客户端（在你手机上装的那个），利用后台传过来的那个参数调起支付宝，让支付宝客户端传给他们服务器交互，进行付款。(这一步是支付宝自己完成的，安全性高)</li>
<li>支付宝的服务器将支付的结果（可能成功也可能不成功）返回给手机支付宝客户端和你们公司的后台服务器。</li>
<li>你们公司后台服务器收到后一般是更新下数据信息（这个咱们不用管），手机支付宝客户端会显示一下支付成功，咱们的客户端也可以显示一个订单支付成功之类的东西。</li>
</ol>
<p><code>到这里就完成了支付的过程了。看着挺简单,坑还是挺多的</code></p>
<p>其中商户客户端需要做的就是：</p>
<ul>
<li>调用支付宝支付接口</li>
<li>处理支付宝返回的支付结果</li>
</ul>
<p><a href="https://doc.open.alipay.com/doc2/detail.htm?spm=0.0.0.0.uY7E41&amp;treeId=59&amp;articleId=103657&amp;docType=1" target="_blank" rel="external">支付宝文档上的应用范例</a></p>
<p>ps:签名部分为了安全起见都放在了后台，如果你们执意要在手机客户端做签名，不怕被拦截那就再加上一步签名。</p>
<h4 id="支付SDK下载"><a href="#支付SDK下载" class="headerlink" title="支付SDK下载"></a>支付SDK下载</h4><img src="/2016/07/23/支付宝支付集成/png2.png" alt="官方流程图" title="官方流程图">
<p><a href="https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.u0bRko&amp;treeId=59&amp;articleId=103676&amp;docType=1" target="_blank" rel="external">iOS集成支付宝文档:</a></p>
<ul>
<li><p>官方文档那叫一个简洁,看后留下懵逼的我继续懵逼,稍微吐槽一下,集成过银联和微信后,最简单的是银联支付集成,其次是微信集成,最恶心的就是支付宝集成,后面你就会发现有多恶心!</p>
</li>
<li><p>支付宝集成和微信集成一样需要先在支付宝开放平台上注册你自己的App,不仅如此,还需要获取在开放平台获取你商户App的公钥和私钥,这部分一般开发经理会给你申请好,不会的按照支付宝开放平台的步骤来,这里只介绍如何把支付宝集成到你的项目中.</p>
</li>
</ul>
<h5 id="开始集成"><a href="#开始集成" class="headerlink" title="开始集成:"></a>开始集成:</h5><p>下载SDK后文件夹结构如下</p>
<img src="/2016/07/23/支付宝支付集成/png3.png" alt="官方流程图" title="官方流程图">
<h5 id="添加sdk文件到xcode-这一步需要注意-一定要按我的步骤来-这一步也有坑"><a href="#添加sdk文件到xcode-这一步需要注意-一定要按我的步骤来-这一步也有坑" class="headerlink" title="添加sdk文件到xcode(这一步需要注意,一定要按我的步骤来,这一步也有坑)"></a>添加sdk文件到xcode(这一步需要注意,一定要按我的步骤来,这一步也有坑)</h5><p><code>打开项目--&gt;Show in Finder(打开你的项目源文件目录如下图)</code></p>
<img src="/2016/07/23/支付宝支付集成/png4.png" alt="官方流程图" title="官方流程图">
<p>图中<code>AlipaySDK.bundle</code>文件就在刚刚解压的SDK第一层目录下,而<code>openssl</code>文件夹和<code>Util</code>文件夹可以按下图路劲获取:</p>
<img src="/2016/07/23/支付宝支付集成/png5.png" alt="官方流程图" title="官方流程图">
<p>然后把你新建的文件夹拖入你的工程(我这里就把整个AlipaySDK文件夹拖入工程即可)</p>
<h5 id="添加依赖库-一个都不能少哦"><a href="#添加依赖库-一个都不能少哦" class="headerlink" title="添加依赖库(一个都不能少哦!)"></a>添加依赖库(一个都不能少哦!)</h5><p><code>点击工程--&gt;点击General--&gt;滚动到最下面展开Linked  Frameworks  andLibraries--&gt;点击+号</code>搜索库文件添加即可</p>
<img src="/2016/07/23/支付宝支付集成/png6.png" alt="官方流程图" title="官方流程图">
<h5 id="现在Cmd-B-编译项目，会出现以下问题："><a href="#现在Cmd-B-编译项目，会出现以下问题：" class="headerlink" title="现在Cmd + B 编译项目，会出现以下问题："></a>现在Cmd + B 编译项目，会出现以下问题：</h5><h6 id="1）-quot-Unknown-type-name-‘NSString‘-quot-或者-quot-Unknown-type-name-‘NSData‘-quot-等不识别常见类的问题。"><a href="#1）-quot-Unknown-type-name-‘NSString‘-quot-或者-quot-Unknown-type-name-‘NSData‘-quot-等不识别常见类的问题。" class="headerlink" title="1）&quot;Unknown type name ‘NSString‘ &quot;或者&quot;Unknown type name ‘NSData‘ &quot;等不识别常见类的问题。"></a>1）<code>&quot;Unknown type name ‘NSString‘ &quot;</code>或者<code>&quot;Unknown type name ‘NSData‘ &quot;</code>等不识别常见类的问题。</h6><img src="/2016/07/23/支付宝支付集成/png7.png" alt="官方流程图" title="官方流程图">
<p>这是因为缺少Foundation类库和UIKit类库，支付宝Demo中之所以没有出现此错误，是因为在.pch文件中导入过这些类库</p>
<h5 id="解决方法1-也添加一个-pch文件"><a href="#解决方法1-也添加一个-pch文件" class="headerlink" title="解决方法1:也添加一个.pch文件"></a>解决方法1:也添加一个.pch文件</h5><p>(如果项目中已经有pch文件,在pch文件中导入Foundation类库和UIKit类库即可)</p>
<img src="/2016/07/23/支付宝支付集成/png8.png" alt="官方流程图" title="官方流程图">
<p><code>.Pch文件</code>中的代码:</p>
<img src="/2016/07/23/支付宝支付集成/png9.png" alt="官方流程图" title="官方流程图">
<h5 id="解决办法2：只需要在出现错误的文件中导入这些类库即可"><a href="#解决办法2：只需要在出现错误的文件中导入这些类库即可" class="headerlink" title="解决办法2：只需要在出现错误的文件中导入这些类库即可"></a>解决办法2：只需要在出现错误的文件中导入这些类库即可</h5><img src="/2016/07/23/支付宝支付集成/png10.png" alt="官方流程图" title="官方流程图">
<h6 id="2）‘openssl-asn1-h‘-file-not-found-这个文件找不到"><a href="#2）‘openssl-asn1-h‘-file-not-found-这个文件找不到" class="headerlink" title="2）‘openssl/asn1.h‘ file not found   这个文件找不到"></a>2）‘openssl/asn1.h‘ file not found   这个文件找不到</h6><p>这是openssl文件夹头文件链接问题，如果在<code>添加SDK到Xcode中</code>那一步时,openssl文件夹是你随意拉进项目中的，那么即使使用下面的方法添加头文件链接，也可能解决不了此问题，所以添加SDK那一步很重要.这也是问什么一开始就将所需要的文件放到一个新建文件夹中再添加到项目中的原因。</p>
<p>解决办法：<code>Targets-&gt;Build Settings-&gt;Header Search Path中添加你在添加SDK时新建的文件夹(AlipaySDK文件夹)的路径</code></p>
<img src="/2016/07/23/支付宝支付集成/png11.png" alt="官方流程图" title="官方流程图">
<h5 id="添加URL-Schemes"><a href="#添加URL-Schemes" class="headerlink" title="添加URL Schemes"></a>添加URL Schemes</h5><img src="/2016/07/23/支付宝支付集成/png12.png" alt="官方流程图" title="官方流程图">
<h5 id="添加demo中的Order类到你的项目中"><a href="#添加demo中的Order类到你的项目中" class="headerlink" title="添加demo中的Order类到你的项目中"></a>添加demo中的Order类到你的项目中</h5><img src="/2016/07/23/支付宝支付集成/png13.png" alt="官方流程图" title="官方流程图">
<h5 id="创建一个继承自NSobject的支付宝支付管理工具类和一个支付宝返回数据模型类"><a href="#创建一个继承自NSobject的支付宝支付管理工具类和一个支付宝返回数据模型类" class="headerlink" title="创建一个继承自NSobject的支付宝支付管理工具类和一个支付宝返回数据模型类"></a>创建一个继承自NSobject的<code>支付宝支付管理工具类</code>和一个<code>支付宝返回数据模型类</code></h5><img src="/2016/07/23/支付宝支付集成/png14.png" alt="官方流程图" title="官方流程图">
<h4 id="AlipayManager-h文件中的代码-你可以直接复制过去"><a href="#AlipayManager-h文件中的代码-你可以直接复制过去" class="headerlink" title="AlipayManager.h文件中的代码(你可以直接复制过去)"></a>AlipayManager.h文件中的代码(你可以直接复制过去)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">//  AlipayManager.h</span><br><span class="line">//  Zoumoledong</span><br><span class="line">//</span><br><span class="line">//  Created by 赵新成 on 16/7/20.</span><br><span class="line">//  Copyright © 2016年 赵新成. All rights reserved.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">	#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">@interface AlipayManager : NSObject</span><br><span class="line">+ (instancetype)sharedInstance;</span><br><span class="line"></span><br><span class="line">//- (void)parse:(NSURL *)url application:(UIApplication *)application;</span><br><span class="line">//- (void)paymentResult:(NSString *)resultd;</span><br><span class="line"></span><br><span class="line">//阿里支付,obj是待支付商品的信息,需要按实际需求自行设置</span><br><span class="line">- (void)aliPayOrder:(NSDictionary *)obj block:(void(^)(BOOL res))block;</span><br><span class="line"></span><br><span class="line">//签名校验</span><br><span class="line">- (void)parseResult:(NSDictionary *)dic  block:(void(^)(BOOL success)) block;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h4 id="AlipayManager-m文件中的代码-你可以直接复制过去"><a href="#AlipayManager-m文件中的代码-你可以直接复制过去" class="headerlink" title="AlipayManager.m文件中的代码(你可以直接复制过去)"></a>AlipayManager.m文件中的代码(你可以直接复制过去)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">//  AlipayManager.m</span><br><span class="line">//  Zoumoledong</span><br><span class="line">//</span><br><span class="line">//  Created by 赵新成 on 16/7/20.</span><br><span class="line">//  Copyright © 2016年 赵新成. All rights reserved.</span><br><span class="line">//支付宝支付管理类</span><br><span class="line"></span><br><span class="line">	#import &quot;AlipayManager.h&quot;</span><br><span class="line">	#import &quot;AlipayResultModel.h&quot;</span><br><span class="line">	#import &quot;DataVerifier.h&quot;</span><br><span class="line">	#import &quot;Order.h&quot;</span><br><span class="line"></span><br><span class="line">	#import &quot;DataSigner.h&quot;</span><br><span class="line">	#import &lt;AlipaySDK/AlipaySDK.h&gt;</span><br><span class="line">	#import &lt;UIKit/UIView.h&gt;</span><br><span class="line"></span><br><span class="line">//#define AlipayPartnerID @&quot;这里是由项目经理给你的&quot;   ////商户的唯一标识,以2088开头</span><br><span class="line">//#define AlipaySellereMail @&quot;这个由项目经理给你&quot;//@&quot;xugongbo@haier.com&quot;  //支付宝账户</span><br><span class="line">//#define AplipayScheme @&quot;alisdkdemo&quot;   //应用注册URL scheme 一致</span><br><span class="line">//商户私钥</span><br><span class="line">//#define AlipayPrivateKey @&quot;商户密钥&quot;</span><br><span class="line"></span><br><span class="line">//支付宝公钥</span><br><span class="line">	#define AlipayPubKey   @&quot;支付宝公钥&quot;</span><br><span class="line"></span><br><span class="line">	#pragma mark - 判断字符串是否为空</span><br><span class="line">	#define STR_IS_NIL(key) (([@&quot;&lt;null&gt;&quot; isEqualToString:(key)] || [@&quot;&quot; isEqualToString:(key)] || key == nil || [key isKindOfClass:[NSNull class]]) ? 1: 0)</span><br><span class="line"></span><br><span class="line">@implementation AlipayManager</span><br><span class="line">+ (instancetype)sharedInstance&#123;</span><br><span class="line">    static AlipayManager *instance = nil;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        if (instance == nil) &#123;</span><br><span class="line">            instance = [[self alloc] init];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    return instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//封装的调用支付宝的支付的接口,obj是商品信息数据,block是作为付款是否成功的bool值,res为YES说明支付成功</span><br><span class="line">- (void)aliPayOrder:(NSDictionary *)obj block:(void(^)(BOOL res))block</span><br><span class="line">&#123;</span><br><span class="line">    /*</span><br><span class="line">     *生成订单信息及签名</span><br><span class="line">     */</span><br><span class="line">    //将商品信息赋予AlixPayOrder的成员变量</span><br><span class="line">    Order *order = [[Order alloc] init];</span><br><span class="line">    </span><br><span class="line">    order.partner = AlipayPartnerID;      //商户的唯一标识</span><br><span class="line">    order.sellerID = AlipaySellereMail;    //支付宝账户</span><br><span class="line">    order.totalFee = [obj objectForKey:@&quot;totalFee&quot;];//订单金额</span><br><span class="line">    order.outTradeNO = [obj objectForKey:@&quot;outTradeNO&quot;]; //订单ID（由商家自行制定）</span><br><span class="line">    </span><br><span class="line">    order.subject = [obj objectForKey:@&quot;subject&quot;];//商品标题</span><br><span class="line">    order.body = [obj objectForKey:@&quot;body&quot;];//商品描述</span><br><span class="line">    </span><br><span class="line">    /*********************************其他必传参数*********************************/</span><br><span class="line">    order.service = @&quot;mobile.securitypay.pay&quot;;</span><br><span class="line">    order.inputCharset = @&quot;utf-8&quot;;</span><br><span class="line">    order.notifyURL =  [obj objectForKey:@&quot;notifyURL&quot;];   //支付宝通知回调url</span><br><span class="line">    </span><br><span class="line">    /*********************************可选参数*********************************/</span><br><span class="line">    order.paymentType = @&quot;1&quot;;</span><br><span class="line">    order.itBPay = @&quot;30m&quot;;</span><br><span class="line">    order.showURL =  @&quot;m.alipay.com&quot;;</span><br><span class="line">    </span><br><span class="line">    //应用注册scheme,在AlixPayDemo-Info.plist定义URL types</span><br><span class="line">    NSString *appScheme = AplipayScheme;</span><br><span class="line">    </span><br><span class="line">    //将商品信息拼接成字符串</span><br><span class="line">    NSString *orderSpec = [order description];</span><br><span class="line">    NSLog(@&quot;orderSpec = %@&quot;,orderSpec);</span><br><span class="line">    </span><br><span class="line">    //获取私钥并将商户信息签名,外部商户可以根据情况存放私钥和签名,只需要遵循RSA签名规范,并将签名字符串base64编码和UrlEncode</span><br><span class="line">    id&lt;DataSigner&gt; signer = CreateRSADataSigner(AlipayPrivateKey);</span><br><span class="line">    //给商品信息签名</span><br><span class="line">    NSString *signedString = [signer signString:orderSpec];</span><br><span class="line">    </span><br><span class="line">    //将签名成功字符串格式化为订单字符串,请严格按照该格式</span><br><span class="line">    NSString *orderString = nil;</span><br><span class="line">    if (signedString != nil) &#123;</span><br><span class="line">        //拼接成订单字符串</span><br><span class="line">        orderString = [NSString stringWithFormat:@&quot;%@&amp;sign=\&quot;%@\&quot;&amp;sign_type=\&quot;%@\&quot;&quot;,</span><br><span class="line">                       orderSpec, signedString, @&quot;RSA&quot;];</span><br><span class="line">        //__weak typeof(self) bself = self;</span><br><span class="line">        </span><br><span class="line">        //发起真正的支付宝支付</span><br><span class="line">        [[AlipaySDK defaultService] payOrder:orderString fromScheme:appScheme callback:^(NSDictionary *resultDic) &#123;</span><br><span class="line">            </span><br><span class="line">	#pragma mark - 这个block为什么没有被调用</span><br><span class="line">            </span><br><span class="line">            NSLog(@&quot;reslut = %@&quot;,resultDic);</span><br><span class="line">            NSLog(@&quot;提示信息%@&quot;, [resultDic objectForKey:@&quot;memo&quot;]);</span><br><span class="line">          </span><br><span class="line">            //获取到resultDic返回结果的字典后进行签名校验</span><br><span class="line">            [self parseResult:resultDic block:^(BOOL success) &#123;</span><br><span class="line">                if (success)</span><br><span class="line">                &#123;</span><br><span class="line">                    //goto成功页面</span><br><span class="line">                    block(YES);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line"></span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	#pragma mark - 签名校验方法</span><br><span class="line">	#pragma mark Ali Pay</span><br><span class="line">- (void)parseResult:(NSDictionary *)dic block:(void(^)(BOOL success)) block</span><br><span class="line">&#123;</span><br><span class="line">    //结果处理,先进行字典转模型</span><br><span class="line">    AlipayResultModel* result = [self handleOpenDic:dic];</span><br><span class="line">    </span><br><span class="line">    if (result)</span><br><span class="line">    &#123;</span><br><span class="line">        if (result.statusCode == 9000)</span><br><span class="line">        &#123;</span><br><span class="line">            /*</span><br><span class="line">             *用公钥验证签名 严格验证请使用result.resultString与result.signString验签</span><br><span class="line">             */</span><br><span class="line">            </span><br><span class="line">            //交易成功</span><br><span class="line">            NSString* key = AlipayPubKey;//签约帐户后获取到的支付宝公钥</span><br><span class="line">            id&lt;DataVerifier&gt; verifier;</span><br><span class="line">            verifier = CreateRSADataVerifier(key);</span><br><span class="line">            </span><br><span class="line">            if ([verifier verifyString:result.resultString withSign:result.signString])</span><br><span class="line">            &#123;</span><br><span class="line">                //验证签名成功，交易结果无篡改</span><br><span class="line">                //[[NSNotificationCenter defaultCenter] postNotificationName:AliPay_Success_Broadcast object:nil];</span><br><span class="line">                block(YES);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                //验证签名失败</span><br><span class="line">                UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@&quot;提示&quot;</span><br><span class="line">                                                                message:@&quot;交易失败&quot;</span><br><span class="line">                                                               delegate:self</span><br><span class="line">                                                      cancelButtonTitle:@&quot;确定&quot;</span><br><span class="line">                                                      otherButtonTitles:nil];</span><br><span class="line">                [alert show];</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if (!STR_IS_NIL(result.statusMessage))</span><br><span class="line">            &#123;</span><br><span class="line">                //交易失败</span><br><span class="line">                UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@&quot;提示&quot;</span><br><span class="line">                                                                message:result.statusMessage</span><br><span class="line">                                                               delegate:self</span><br><span class="line">                                                      cancelButtonTitle:@&quot;确定&quot;</span><br><span class="line">                                                      otherButtonTitles:nil];</span><br><span class="line">                [alert show];</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                //交易失败</span><br><span class="line">                UIAlertView * alert = [[UIAlertView alloc] initWithTitle:@&quot;提示&quot;</span><br><span class="line">                                                                message:@&quot;交易失败&quot;</span><br><span class="line">                                                               delegate:self</span><br><span class="line">                                                      cancelButtonTitle:@&quot;确定&quot;</span><br><span class="line">                                                      otherButtonTitles:nil];</span><br><span class="line">                [alert show];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        //失败</span><br><span class="line">        UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@&quot;提示&quot;</span><br><span class="line">                                                        message:@&quot;交易失败&quot;</span><br><span class="line">                                                       delegate:self</span><br><span class="line">                                              cancelButtonTitle:@&quot;确定&quot;</span><br><span class="line">                                              otherButtonTitles:nil];</span><br><span class="line">        [alert show];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//处理dic这个字典</span><br><span class="line">- (AlipayResultModel *)handleOpenDic:(NSDictionary *)dic &#123;</span><br><span class="line">    AlipayResultModel * result = nil;</span><br><span class="line">    if (dic &amp;&amp; dic.count &gt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        //字典不为空就进行字典转模型</span><br><span class="line">        result = [self resultFromDic:dic];</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//进行字典转模型</span><br><span class="line">- (AlipayResultModel *)resultFromDic:(NSDictionary *)dic</span><br><span class="line">&#123;</span><br><span class="line">    //判断是否为arc模式</span><br><span class="line">	#if ! __has_feature(objc_arc)</span><br><span class="line">    return [[[AlipayResultModel alloc] initWithDic:dic] autorelease];</span><br><span class="line">	#else</span><br><span class="line">    return [[AlipayResultModel alloc] initWithDic:dic];</span><br><span class="line">	#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h4 id="AlipayResultModel-h文件中的代码-你可以直接复制过去"><a href="#AlipayResultModel-h文件中的代码-你可以直接复制过去" class="headerlink" title="AlipayResultModel.h文件中的代码(你可以直接复制过去)"></a>AlipayResultModel.h文件中的代码(你可以直接复制过去)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//</span><br><span class="line">//  AlipayResultModel.h</span><br><span class="line">//  Zoumoledong</span><br><span class="line">//</span><br><span class="line">//  Created by 赵新成 on 16/7/20.</span><br><span class="line">//  Copyright © 2016年 赵新成. All rights reserved.</span><br><span class="line"></span><br><span class="line">//支付宝支付完成后返回的字典,把这个字典转换成当前这个模型</span><br><span class="line"></span><br><span class="line">	#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">@interface AlipayResultModel : NSObject</span><br><span class="line">@property(nonatomic, readonly) int statusCode;</span><br><span class="line">@property(nonatomic, readonly) NSString *statusMessage;</span><br><span class="line">@property(nonatomic, readonly) NSString *resultString;</span><br><span class="line">@property(nonatomic, readonly) NSString *signString;</span><br><span class="line">@property(nonatomic, readonly) NSString *signType;</span><br><span class="line"></span><br><span class="line">//把字典先缓缓成模型</span><br><span class="line">- (id)initWithDic:(NSDictionary *)dic;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h4 id="AlipayResultModel-m文件中的代码-你可以直接复制过去"><a href="#AlipayResultModel-m文件中的代码-你可以直接复制过去" class="headerlink" title="AlipayResultModel.m文件中的代码(你可以直接复制过去)"></a>AlipayResultModel.m文件中的代码(你可以直接复制过去)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//</span><br><span class="line">//  AlipayResultModel.m</span><br><span class="line">//  Zoumoledong</span><br><span class="line">//</span><br><span class="line">//  Created by 赵新成 on 16/7/20.</span><br><span class="line">//  Copyright © 2016年 赵新成. All rights reserved.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">	#import &quot;AlipayResultModel.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation AlipayResultModel</span><br><span class="line">- (id)initWithDic:(NSDictionary *)jsonQuery &#123;</span><br><span class="line">    </span><br><span class="line">    if (self = [super init]) &#123;</span><br><span class="line">        </span><br><span class="line">        self.statusCode = 0;</span><br><span class="line">        self.statusMessage = @&quot;未知错误。&quot;;</span><br><span class="line">        do &#123;</span><br><span class="line">            </span><br><span class="line">            NSString * jsonMemo = [jsonQuery objectForKey:@&quot;memo&quot;];</span><br><span class="line">            if (jsonMemo == nil) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            self.statusCode = [[jsonQuery objectForKey:@&quot;resultStatus&quot;] intValue];</span><br><span class="line">            self.statusMessage = [jsonQuery objectForKey:@&quot;memo&quot;];</span><br><span class="line">            if (self.statusCode != 9000) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            NSString *resultString = [jsonQuery objectForKey:@&quot;result&quot;];</span><br><span class="line">            </span><br><span class="line">            //</span><br><span class="line">            // 签名类型</span><br><span class="line">            //</span><br><span class="line">            NSRange range = [resultString rangeOfString:@&quot;&amp;sign_type=\&quot;&quot;];</span><br><span class="line">            if (range.location == NSNotFound) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            self.resultString = [resultString substringToIndex:range.location];</span><br><span class="line">            </span><br><span class="line">            range.location += range.length;</span><br><span class="line">            range.length = [resultString length] - range.location;</span><br><span class="line">            NSRange range2 = [resultString rangeOfString:@&quot;\&quot;&quot; options:NSCaseInsensitiveSearch range:range];</span><br><span class="line">            if (range2.location == NSNotFound) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            range.length = range2.location - range.location;</span><br><span class="line">            if (range.length &lt;= 0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            self.signType = [resultString substringWithRange:range];</span><br><span class="line">            </span><br><span class="line">            //</span><br><span class="line">            // 签名字符串</span><br><span class="line">            //</span><br><span class="line">            range.location = range2.location;</span><br><span class="line">            range.length = [resultString length] - range.location;</span><br><span class="line">            range = [resultString rangeOfString:@&quot;sign=\&quot;&quot; options:NSCaseInsensitiveSearch range:range];</span><br><span class="line">            if (range.location == NSNotFound) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            range.location += range.length;</span><br><span class="line">            range.length = [resultString length] - range.location;</span><br><span class="line">            range2 = [resultString rangeOfString:@&quot;\&quot;&quot; options:NSCaseInsensitiveSearch range:range];</span><br><span class="line">            if (range2.location == NSNotFound) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            range.length = range2.location - range.location;</span><br><span class="line">            if (range.length &lt;= 0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            self.signString = [resultString substringWithRange:range];</span><br><span class="line">            </span><br><span class="line">        &#125; while (0);</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">		#if ! __has_feature(objc_arc)</span><br><span class="line">    [_statusMessage release];</span><br><span class="line">    [_resultString release];</span><br><span class="line">    [_signString release];</span><br><span class="line">    [_signType release];</span><br><span class="line">    [super dealloc];</span><br><span class="line">		#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSString *)description &#123;</span><br><span class="line">    NSMutableString * description = [NSMutableString string];</span><br><span class="line">    [description appendString:@&quot;result = &#123;\n&quot;];</span><br><span class="line">    [description appendFormat:@&quot;\tstatusCode=%d\n&quot;, self.statusCode];</span><br><span class="line">    [description appendFormat:@&quot;\tstatusMessage=%@\n&quot;, self.statusMessage];</span><br><span class="line">    [description appendFormat:@&quot;\tsignType=%@\n&quot;, self.signType];</span><br><span class="line">    [description appendFormat:@&quot;\tsignString=%@\n&quot;, self.signString];</span><br><span class="line">    [description appendString:@&quot;&#125;\n&quot;];</span><br><span class="line">    return description;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setSignType:(NSString *)signType &#123;</span><br><span class="line">    if (_signType != signType) &#123;</span><br><span class="line">		#if ! __has_feature(objc_arc)</span><br><span class="line">        [_signType release];</span><br><span class="line">        _signType = [signType retain];</span><br><span class="line">		#else</span><br><span class="line">        _signType = signType;</span><br><span class="line">		#endif</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setSignString:(NSString *)string &#123;</span><br><span class="line">    if (_signString != string) &#123;</span><br><span class="line">		#if ! __has_feature(objc_arc)</span><br><span class="line">        [_signString release];</span><br><span class="line">        _signString = [string retain];</span><br><span class="line">		#else</span><br><span class="line">        _signString = string;</span><br><span class="line">		#endif</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setStatusCode:(int)code &#123;</span><br><span class="line">    _statusCode = code;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setStatusMessage:(NSString *)message &#123;</span><br><span class="line">    if (_statusMessage != message) &#123;</span><br><span class="line">		#if ! __has_feature(objc_arc)</span><br><span class="line">        [_statusMessage release];</span><br><span class="line">        _statusMessage = [message retain];</span><br><span class="line">		#else</span><br><span class="line">        _statusMessage = message;</span><br><span class="line">		#endif</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setResultString:(NSString *)string &#123;</span><br><span class="line">    if (_resultString != string) &#123;</span><br><span class="line">		#if ! __has_feature(objc_arc)</span><br><span class="line">        [_resultString release];</span><br><span class="line">        _resultString = [string retain];</span><br><span class="line">		#else</span><br><span class="line">        _resultString = string;</span><br><span class="line">		#endif</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void) parseFormStr:(NSString*)str</span><br><span class="line">&#123;</span><br><span class="line">    NSString* resultString = str;</span><br><span class="line">		#if __has_feature(objc_arc)</span><br><span class="line">    NSMutableString* name = [[NSMutableString alloc] init];</span><br><span class="line">    NSMutableString* resultStatus = [[NSMutableString alloc] init];</span><br><span class="line">    NSMutableString* memo = [[NSMutableString alloc] init];</span><br><span class="line">    NSMutableString* resultd = [[NSMutableString alloc] init];</span><br><span class="line">    NSMutableString* temp = [[NSMutableString alloc] init];</span><br><span class="line">		#else</span><br><span class="line">    NSMutableString* name = [[[NSMutableString alloc] init] autorelease];</span><br><span class="line">    NSMutableString* resultStatus = [[[NSMutableString alloc] init] autorelease];</span><br><span class="line">    NSMutableString* memo = [[[NSMutableString alloc] init] autorelease];</span><br><span class="line">    NSMutableString* resultd = [[[NSMutableString alloc] init] autorelease];</span><br><span class="line">    NSMutableString* temp = [[[NSMutableString alloc] init] autorelease];</span><br><span class="line">		#endif</span><br><span class="line">    for (int i= 0; i&lt;[resultString  length]; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        unichar tChar = [resultString characterAtIndex:i];</span><br><span class="line">        switch (tChar)</span><br><span class="line">        &#123;</span><br><span class="line">            case &apos;=&apos;:</span><br><span class="line">            &#123;</span><br><span class="line">                if (i&lt;[resultString length]-1)</span><br><span class="line">                &#123;</span><br><span class="line">                    unichar tChar2 = [resultString characterAtIndex:i+1];</span><br><span class="line">                    </span><br><span class="line">                    if (tChar2 == &apos;&#123;&apos;)</span><br><span class="line">                    &#123;</span><br><span class="line">                        [name appendString:temp];</span><br><span class="line">                        [temp setString:@&quot;&quot;];</span><br><span class="line">                        i+=1;</span><br><span class="line">                        </span><br><span class="line">                    &#125;</span><br><span class="line">                    else</span><br><span class="line">                        [temp appendFormat:@&quot;%C&quot;,tChar];</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">                break;</span><br><span class="line">            case &apos;&#125;&apos;:</span><br><span class="line">            &#123;</span><br><span class="line">                if (i&lt;[resultString length]-1)</span><br><span class="line">                &#123;</span><br><span class="line">                    unichar tChar2 = [resultString characterAtIndex:i+1];</span><br><span class="line">                    </span><br><span class="line">                    if (tChar2 != &apos;;&apos;)</span><br><span class="line">                    &#123;</span><br><span class="line">                        [temp appendFormat:@&quot;%C&quot;,tChar];</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                i+=1;</span><br><span class="line">                </span><br><span class="line">                if ([name compare:@&quot;resultStatus&quot;] == 0)</span><br><span class="line">                &#123;</span><br><span class="line">                    [resultStatus appendString:temp];</span><br><span class="line">                &#125;</span><br><span class="line">                else if([name compare:@&quot;memo&quot;] == 0)</span><br><span class="line">                &#123;</span><br><span class="line">                    [memo appendString:temp];</span><br><span class="line">                &#125;</span><br><span class="line">                else if([name compare:@&quot;result&quot;] == 0)</span><br><span class="line">                &#123;</span><br><span class="line">                    [resultd appendString:temp];</span><br><span class="line">                &#125;</span><br><span class="line">                //save value</span><br><span class="line">                [temp setString:@&quot;&quot;];</span><br><span class="line">                [name setString:@&quot;&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">            &#123;</span><br><span class="line">                [temp appendFormat:@&quot;%C&quot;,tChar];</span><br><span class="line">            &#125;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    do</span><br><span class="line">    &#123;</span><br><span class="line">        NSRange range = [resultd rangeOfString:@&quot;&amp;sign_type=\&quot;&quot;];</span><br><span class="line">        if (range.location == NSNotFound) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        //self.resultString = [resultd substringToIndex:range.location];</span><br><span class="line">        </span><br><span class="line">        range.location += range.length;</span><br><span class="line">        range.length = [resultd length] - range.location;</span><br><span class="line">        NSRange range2 = [resultd rangeOfString:@&quot;\&quot;&quot; options:NSCaseInsensitiveSearch range:range];</span><br><span class="line">        if (range2.location == NSNotFound) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        range.length = range2.location - range.location;</span><br><span class="line">        if (range.length &lt;= 0) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        self.signType = [resultd substringWithRange:range];</span><br><span class="line">        </span><br><span class="line">        //</span><br><span class="line">        // 签名字符串</span><br><span class="line">        //</span><br><span class="line">        range = [resultd rangeOfString:@&quot;sign=\&quot;&quot;];</span><br><span class="line">        if (range.location == NSNotFound) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        range2.location = 0;</span><br><span class="line">        range2.length = range.location-1;</span><br><span class="line">        self.resultString = [resultd substringWithRange:range2];</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        //</span><br><span class="line">        // 签名类型</span><br><span class="line">        //</span><br><span class="line">        range2 = [resultd rangeOfString:@&quot;&amp;sign_type=\&quot;&quot;];</span><br><span class="line">        </span><br><span class="line">        range = [resultd rangeOfString:@&quot;&amp;sign=\&quot;&quot;];</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        range.location += range.length;</span><br><span class="line">        range.length = range2.location - range.location-1;</span><br><span class="line">        </span><br><span class="line">        self.signString = [resultd substringWithRange:range];</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        break;</span><br><span class="line">    &#125; while (0);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    self.statusCode = [resultStatus intValue];</span><br><span class="line">    self.statusMessage = memo;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h4 id="在点击支付宝支付按钮的控制器导入我们自己封装的管理支付宝SDK的头文件"><a href="#在点击支付宝支付按钮的控制器导入我们自己封装的管理支付宝SDK的头文件" class="headerlink" title="在点击支付宝支付按钮的控制器导入我们自己封装的管理支付宝SDK的头文件"></a>在点击支付宝支付按钮的控制器导入我们自己封装的管理支付宝SDK的头文件</h4><pre><code>#import &quot;AlipayManager.h&quot;
</code></pre><h4 id="点击支付宝按钮调用的方法"><a href="#点击支付宝按钮调用的方法" class="headerlink" title="点击支付宝按钮调用的方法"></a>点击支付宝按钮调用的方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//支付宝支付</span><br><span class="line">- (IBAction)Alipay &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    NSMutableDictionary * goodsInfoDict = [[NSMutableDictionary alloc] init];</span><br><span class="line">    [goodsInfoDict setObject:@&quot;0.01&quot; forKey:@&quot;totalFee&quot;];  //订单金额,从后台获取</span><br><span class="line">    [goodsInfoDict setObject:[self generateTradeNO] forKey:@&quot;outTradeNO&quot;];  //订单号（由商家自行制定）</span><br><span class="line">    [goodsInfoDict setObject:@&quot;1&quot; forKey:@&quot;subject&quot;];    //商品标题,按实际情况填写</span><br><span class="line">    [goodsInfoDict setObject:@&quot;我是测试数据&quot; forKey:@&quot;body&quot;];        //商品描述</span><br><span class="line">    [goodsInfoDict setObject:@&quot;http://www.xxx.com&quot; forKey:@&quot;notifyURL&quot;];    //支付宝通知回调url</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    NSDictionary * obj = [goodsInfoDict copy];</span><br><span class="line">    //阿里支付</span><br><span class="line">    [[AlipayManager sharedInstance] aliPayOrder:obj block:^(BOOL res) &#123;</span><br><span class="line">        //res为YES就说明支付成功</span><br><span class="line">        if (res)</span><br><span class="line">        &#123;</span><br><span class="line">            //这里写支付成功后的逻辑,比如跳转到支付成功的页面</span><br><span class="line">            //交易成功</span><br><span class="line">            UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@&quot;提示&quot;</span><br><span class="line">                                                            message:@&quot;支付成功&quot;</span><br><span class="line">                                                           delegate:self</span><br><span class="line">                                                  cancelButtonTitle:@&quot;确定&quot;</span><br><span class="line">                                                  otherButtonTitles:nil];</span><br><span class="line">            [alert show];</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="由于是测试的Demo-还需要在支付方法下面添加一个方法-需要写一个产生随机订单号的方法以供上面支付方法调用"><a href="#由于是测试的Demo-还需要在支付方法下面添加一个方法-需要写一个产生随机订单号的方法以供上面支付方法调用" class="headerlink" title="由于是测试的Demo,还需要在支付方法下面添加一个方法,需要写一个产生随机订单号的方法以供上面支付方法调用"></a>由于是测试的Demo,还需要在支付方法下面添加一个方法,需要写一个产生随机订单号的方法以供上面支付方法调用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">	#pragma mark   ==============产生随机订单号==============</span><br><span class="line">- (NSString *)generateTradeNO</span><br><span class="line">&#123;</span><br><span class="line">    static int kNumber = 15;</span><br><span class="line">    </span><br><span class="line">    NSString *sourceStr = @&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;</span><br><span class="line">    NSMutableString *resultStr = [[NSMutableString alloc] init];</span><br><span class="line">    srand((unsigned)time(0));</span><br><span class="line">    for (int i = 0; i &lt; kNumber; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        unsigned index = rand() % [sourceStr length];</span><br><span class="line">        NSString *oneStr = [sourceStr substringWithRange:NSMakeRange(index, 1)];</span><br><span class="line">        [resultStr appendString:oneStr];</span><br><span class="line">    &#125;</span><br><span class="line">    return resultStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </section>

</article>

  
<section id="comment">  
  <!-- Disqus评论框 start -->
  <section id="comments">
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'xincheng'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>
<!-- Disqus公共JS代码 end -->  
</section>  
  

            <footer class="footer">
    <span class="footer__copyright">
        本站点采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2016 - 本站由 <a href="/">@Longbo Ma</a> 创建,
        使用<a href="https://github.com/lenbo-ma/hexo-theme-vno">hexo-theme-vno</a>主题,
        修改自<a href="http://github.com/onevcat/vno" target="_blank">Vno</a>
    </span>
</footer>

        </div>
    </div>

    <script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>

     
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-42596364-1', 'auto');
	ga('send', 'pageview');
</script>

</body>
</html>
